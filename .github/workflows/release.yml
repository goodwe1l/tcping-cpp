name: Build and Release

on:
  push:
    tags:
      - "v*" # å½“æ¨é€ä»¥ v å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘ï¼ˆå¦‚ v1.0.0ï¼‰

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # Linux æ„å»º
          - os: ubuntu-latest
            target: linux-x64
            artifact_name: tcping
            asset_name: tcping-linux-x64
          # macOS æ„å»º (Intel)
          - os: macos-13
            target: macos-x64
            artifact_name: tcping
            asset_name: tcping-macos-x64
          # macOS æ„å»º (Apple Silicon)
          - os: macos-latest
            target: macos-arm64
            artifact_name: tcping
            asset_name: tcping-macos-arm64
          # Windows æ„å»º
          - os: windows-latest
            target: windows-x64
            artifact_name: tcping.exe
            asset_name: tcping-windows-x64.exe

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup build environment (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            sudo apt-get update
            sudo apt-get install -y build-essential g++
          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            # macOS å·²ç»é¢„å®‰è£…äº† Xcode å‘½ä»¤è¡Œå·¥å…·
            xcode-select --install 2>/dev/null || true
          fi

      - name: Setup build environment (Windows)
        if: runner.os == 'Windows'
        uses: microsoft/setup-msbuild@v2
        with:
          msbuild-architecture: x64

      - name: Build (Linux/macOS)
        if: runner.os != 'Windows'
        working-directory: tcping-src
        run: |
          chmod +x build.sh
          ./build.sh
          # éªŒè¯æ„å»ºç»“æœ
          ls -la tcping
          file tcping

      - name: Build (Windows)
        if: runner.os == 'Windows'
        working-directory: tcping-src
        run: |
          # è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"

          # ç¼–è¯‘
          cl /EHsc /O2 /std:c++11 /D "OS_WINDOWS" /I. main.cpp tcping.cpp base64.cpp tee.cpp ws-util.cpp /link ws2_32.lib /out:tcping.exe

          # éªŒè¯æ„å»ºç»“æœ
          dir tcping.exe
        shell: cmd

      - name: Create version info
        working-directory: tcping-src
        run: |
          echo "TCPING_VERSION=${GITHUB_REF#refs/tags/}" >> version_info.txt
          echo "BUILD_DATE=$(date -u +%Y-%m-%d\ %H:%M:%S)" >> version_info.txt
          echo "BUILD_OS=${{ matrix.target }}" >> version_info.txt
          echo "GIT_COMMIT=${GITHUB_SHA}" >> version_info.txt

      - name: Test binary
        working-directory: tcping-src
        run: |
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            ./tcping.exe --help || echo "Help command executed"
          else
            ./tcping --help || echo "Help command executed"
          fi

      - name: Prepare artifact
        working-directory: tcping-src
        run: |
          mkdir -p ../release
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            cp tcping.exe ../release/${{ matrix.asset_name }}
          else
            cp tcping ../release/${{ matrix.asset_name }}
          fi
          cp version_info.txt ../release/
          cp README.md ../release/ 2>/dev/null || echo "README.md not found"
          cp gpl-2.0.txt ../release/ 2>/dev/null || echo "gpl-2.0.txt not found"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.asset_name }}
          path: release/

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Prepare release assets
        run: |
          mkdir -p release_assets

          # ç§»åŠ¨æ‰€æœ‰æ„å»ºçš„äºŒè¿›åˆ¶æ–‡ä»¶åˆ° release_assets ç›®å½•
          find artifacts/ -name "tcping*" -type f -executable -o -name "*.exe" | while read file; do
            cp "$file" release_assets/
          done

          # å¤åˆ¶æ–‡æ¡£æ–‡ä»¶
          cp artifacts/*/README.md release_assets/ 2>/dev/null || echo "README.md not found"
          cp artifacts/*/gpl-2.0.txt release_assets/ 2>/dev/null || echo "gpl-2.0.txt not found"

          # åˆ›å»º SHA256 æ ¡éªŒå’Œæ–‡ä»¶
          cd release_assets
          for file in tcping*; do
            if [[ -f "$file" ]]; then
              sha256sum "$file" >> SHA256SUMS.txt
            fi
          done

          ls -la

      - name: Extract tag name
        id: tag
        run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.tag.outputs.TAG_NAME }}
          release_name: TCPING ${{ steps.tag.outputs.TAG_NAME }}
          body: |
            ## TCPING Cross-Platform Release ${{ steps.tag.outputs.TAG_NAME }}

            ### ğŸš€ Features
            - Cross-platform TCP connectivity testing tool
            - Support for Windows, Linux, and macOS
            - HTTP/HTTPS probing capabilities
            - IPv4/IPv6 support
            - Jitter measurement
            - Proxy support

            ### ğŸ“¦ Downloads
            Choose the appropriate binary for your platform:

            - **Windows (x64)**: `tcping-windows-x64.exe`
            - **Linux (x64)**: `tcping-linux-x64`
            - **macOS (Intel)**: `tcping-macos-x64`
            - **macOS (Apple Silicon)**: `tcping-macos-arm64`

            ### ğŸ“‹ Usage
            ```bash
            # Basic usage
            ./tcping google.com 80

            # Continuous ping
            ./tcping -t google.com 443

            # HTTP mode
            ./tcping -h example.com

            # Show help
            ./tcping --help
            ```

            ### ğŸ” Verification
            Verify the integrity of downloaded files using the provided `SHA256SUMS.txt`.

            ### ğŸ“ Changes
            See commit history for detailed changes since the last release.

            ---

            **Build Information:**
            - Built on: $(date -u +%Y-%m-%d\ %H:%M:%S) UTC
            - Commit: ${{ github.sha }}
          draft: false
          prerelease: false

      - name: Upload Release Assets
        run: |
          cd release_assets
          for file in *; do
            if [[ -f "$file" ]]; then
              echo "Uploading $file..."
              curl \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Content-Type: application/octet-stream" \
                --data-binary @"$file" \
                "https://uploads.github.com/repos/${{ github.repository }}/releases/${{ steps.create_release.outputs.id }}/assets?name=$file"
            fi
          done

  # å¯é€‰ï¼šè‡ªåŠ¨åŒ–æµ‹è¯•æ­¥éª¤
  test:
    name: Integration Test
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: tcping-linux-x64
          path: ./

      - name: Make executable
        run: chmod +x tcping-linux-x64

      - name: Test basic functionality
        run: |
          # æµ‹è¯•å¸®åŠ©ä¿¡æ¯
          ./tcping-linux-x64 --help

          # æµ‹è¯•ç‰ˆæœ¬ä¿¡æ¯
          ./tcping-linux-x64 -v || true

          # æµ‹è¯•åŸºæœ¬è¿æ¥ï¼ˆè¶…æ—¶è®¾ç½®è¾ƒçŸ­ï¼‰
          timeout 10s ./tcping-linux-x64 -n 1 -w 2 google.com 80 || echo "Connection test completed"
